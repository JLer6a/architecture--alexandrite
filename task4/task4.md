# Цели и задачи логирования
Основная цель — повысить наблюдаемость (observability) системы: ускорить разбор инцидентов, уменьшить зависимость от слов клиентов, выявлять узкие места, мониторить загрузку и предсказывать потенциальные сбои.
## Дополнительные цели:
   - Повысить эффективность технической поддержки.
   - Снизить потери заказов, устранить слепые зоны в архитектуре.
   - Повысить доверие B2B-партнёров и снизить риски SLA-нарушений.


# Какие логи нужно собирать
## Логи уровня INFO (регулярные события):
   - Изменение статуса заказа (из Интернет-магазин, CRM, MES)
   - Начало расчёта стоимости (из MES API)
   - Завершение расчёта стоимости (из MES API)
   - Вызов API партнёром (из MES API)
   - Ошибка валидации данных (из Все API)
   - Действия оператора в MES (из MES)
   - Изменение данных клиента (из CRM)
   - Взаимодействие между системами (из RabbitMQ)
   - Очередь сообщений (из RabbitMQ)
## Логи уровня WARN:
   - Долгое выполнение расчёта (более 5 минут).
   - Повторная отправка сообщения в очередь.
   - Попытка обновить заказ в невалидном статусе.
   - Пустой или некорректный файл 3D-модели.
## Логи уровня ERROR:
   - Ошибка расчёта стоимости.
   - Сбой отправки/получения сообщений RabbitMQ.
   - Ошибка подключения к БД.
   - Исключения при вызове стороннего API.


# Мотивация
## Почему нужно внедрить логирование:
### Текущая ситуация:
   - Компания реагирует на инциденты по жалобам клиентов.
   - Отсутствует единая точка анализа проблем.
### Бизнес-эффекты:
   - Повышение SLA-доверия у B2B-партнёров.
   - Уменьшение времени на поддержку.
   - Снижение потерь заказов из-за невидимых ошибок.
   - Увеличение прозрачности работы MES и CRM.
### Метрики, которые улучшатся:
   - Время расследования инцидента (MTTR).
   - Уровень успешных расчётов стоимости.
   - Количество необработанных или "зависших" заказов.
   - Время отклика на партнёрские API-запросы.
   - Количество ошибок, не замеченных клиентами.


# Приоритет внедрения логирования
## Первая очередь:
   - MES API — основная нагрузка, слабое звено (узкое горлышко).
   - CRM API — второй уровень взаимодействия.
   - RabbitMQ — транспорт между критичными частями системы.
## Вторая очередь:
   - MES Web-приложение (для действий операторов).
   - Онлайн-магазин (в основном для B2C клиентов).


# Предлагаемое решение
## Технологии и компоненты:
   - Логгер: встроенный логгер приложений: logback (Java), winston (Node.js/Vue).
   - Формат: JSON для парсинга и индексации.
   - Агент логирования: Filebeat или Fluent Bit — собирает и отправляет логи.
   - Хранилище логов: Elasticsearch.
   - Анализ и визуализация: Kibana.
   - Централизованное логирование: Logstash (по необходимости).


# Политика безопасности:
   1. Все логи обрабатываются без хранения персональных данных в открытом виде.
   2. Используется маскирование для email, phone, fio, card.
   3. Доступ к Kibana:
      - Только по VPN или внутренней сети.
      - Разграничен по ролям (Dev, QA, Support).


# Политика хранения:
   1. Хранилище логов: по индексу на каждый микросервис.
   2. Ротация:
      - Продолжительность хранения: 30 дней (default), 90 дней — для ошибок.
      - Объём: лимитируем ~100 ГБ/мес (можно расширить при росте). 
   3. Архивирование критичных логов в S3 на год.


# Анализ логов:
## Алертинг:
   1. Настраивается через Kibana Watcher или Prometheus + Alertmanager.
   2. Примеры алертов:
      - ошибка 5xx > 10 в минуту. 
      - Время расчёта > 10 минут. 
      - За 5 минут нет новых заказов (если обычно есть).
## Аномалии:
   - Всплеск заказов за секунды.
   - Нестандартные статусы заказов (например, без PRICE_CALCULATED).
   - Резкое снижение количества расчётов стоимости.